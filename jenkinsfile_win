pipeline {
    agent any

    environment {
        GROQ_API_KEY     = credentials('groq_api_key')
        GITHUB_TOKEN     = credentials('github_token')
        GITHUB_CREDENTIALS_USR = credentials('GITHUB_CREDENTIALS_USR')
        GITHUB_CREDENTIALS_PSW = credentials('GITHUB_CREDENTIALS_PSW')
        GIT_BRANCH = "ai-tests"
        REPO_URL = "https://${GITHUB_CREDENTIALS_USR}:${GITHUB_CREDENTIALS_PSW}@github.com/saurabhstatusneo-crypto/jagah.git"
        HUSKY_SKIP_INSTALL = '0'
        JAVA_HOME = "C:\\Program Files\\Java\\jdk-21"
        MAVEN_HOME = "C:\\apache-maven-3.8.3"
        PATH = "${env.MAVEN_HOME}/bin:${env.JAVA_HOME}/bin:${env.PATH}"
    }

    stages {

        stage('Checkout SCM') {
            steps {
                powershell """
                    if (!(Test-Path '.git')) {
                        git clone '${env.REPO_URL}' .
                    } else {
                        git fetch origin
                    }

                    git rev-parse --verify ${env.GIT_BRANCH} > \$null 2>&1
                    if (\$LASTEXITCODE -eq 0) {
                        Write-Host " Switching to existing local branch: ${env.GIT_BRANCH}"
                        git checkout ${env.GIT_BRANCH} > \$null 2>&1

                        git ls-remote --exit-code origin ${env.GIT_BRANCH} > \$null 2>&1
                        if (\$LASTEXITCODE -eq 0) {
                            try { git pull origin ${env.GIT_BRANCH} } catch {}
                        } else {
                            Write-Host " No remote branch to pull from, continuing..."
                        }
                    } else {
                        git ls-remote --exit-code origin ${env.GIT_BRANCH} > \$null 2>&1
                        if (\$LASTEXITCODE -eq 0) {
                            Write-Host " Branch exists on remote. Checking out tracking branch..."
                            try { git checkout -b ${env.GIT_BRANCH} origin/${env.GIT_BRANCH} } catch { git checkout -b ${env.GIT_BRANCH} }
                        } else {
                            Write-Host " Branch does not exist locally or remotely. Creating new branch: ${env.GIT_BRANCH}"
                            git checkout -b ${env.GIT_BRANCH}
                        }
                    }

                    \$LASTEXITCODE = 0
                    exit \$LASTEXITCODE
                """
            }
        }

    stage('Install Node.js Dependencies') {
    steps {
        powershell '''
            Write-Host " Installing Node.js dependencies..."

            # Create package.json if missing
            if (!(Test-Path "package.json")) {
                Write-Host " package.json not found — creating one..."
                npm init -y
            }

            SET HUSKY_SKIP_INSTALL=0

            npm ci
            if ($LASTEXITCODE -ne 0) {
                Write-Host " npm ci failed, continuing..."
            }

            npx husky install
            if ($LASTEXITCODE -ne 0) {
                Write-Host " husky install failed, continuing..."
            }
        '''
    }
}
        stage('Install Java Dependencies') {
            when { expression { fileExists('pom.xml') } }
            steps {
                powershell '''
                    echo "Installing Java/Maven dependencies..."
                      try {
                         mvn clean install -DskipTests
                       } catch {
                        Write-Host "" Maven install failed, continuing
                    }
                '''
            }
        }
      stage('Generate AI Tests') {
    steps {
        script {
            if (fileExists('script/generate-tests.js')) {
                powershell '''
                    # If package.json doesn't exist, create it
                    if (!(Test-Path "package.json")) {
                        Write-Host "package.json not found — creating one..."
                        npm init -y
                    }

                    # Ensure Node runs ESM files
                    $pkg = Get-Content package.json | Out-String | ConvertFrom-Json
                    if ($pkg.type -ne "module") {
                        Write-Host "Setting type=module in package.json..."
                        $pkg.type = "module"
                        $pkg | ConvertTo-Json -Depth 10 | Set-Content package.json
                    }

                    # Run your script
                    node script/generate-tests.js
                '''
            } else {
                echo "generate-tests.js not found — skipping test generation."
            }
        }
    }
}

stage('Lint and Format') {
    steps {
        script {
            if (fileExists('package.json')) {
                powershell '''
                    $scripts = npm run | Select-String -Pattern 'format|lint'

                    if ($scripts) {
                        if ($scripts -match 'format') {
                            try { npm run format } catch { Write-Host " npm format failed" }
                        }

                        if ($scripts -match 'lint') {
                            try { npm run lint } catch { Write-Host " npm lint failed" }
                        }
                    } else {
                        Write-Host " No npm format/lint scripts found. Skipping..."
                    }
                '''
            }

            if (fileExists('pom.xml')) {
                powershell '''
                    try { 
                        mvn checkstyle:check "-Dcheckstyle.failOnViolation=false"
                    }
                    catch {
                        Write-Host " Maven checkstyle failed, continuing..."
                    }
                '''
            }
        }
    }
}

 

        stage('Commit and Push Before PR') {
    steps {
        powershell '''
            Write-Host " Checking for Git changes..."
            git status

            git add .
            try {
                git commit -m "AI Generated Tests"
            } catch {
                Write-Host " Nothing to commit"
            }

            Write-Host " Forcing GitHub token in remote URL..."
            git remote set-url origin "https://${GITHUB_CREDENTIALS_USR}:${GITHUB_CREDENTIALS_PSW}@github.com/saurabhstatusneo-crypto/jagah.git"

            Write-Host " FORCE PUSHING branch..."
            git push origin ai-tests --force
        '''
    }
}


        stage('Run Tests') {
            steps {
                script {
                 

                    if (fileExists('pom.xml')) {
                        powershell '''
                            try { mvn test } catch { Write-Host " Java tests failed, continuing..." }
                        '''
                    }
                }
            }
        }
    }

    post {
        always { echo "Pipeline finished" }
        success { echo " Pipeline succeeded!" }
        failure { echo " Pipeline failed — check logs." }
    }
}
