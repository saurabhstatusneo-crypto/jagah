pipeline {
    agent any

    environment {
        GROQ_API_KEY     = credentials('GROQ-API-KEY')
        GITHUB_TOKEN     = credentials('GITHUB-TOKEN')
        GITHUB_CREDENTIALS = credentials('GITHUB-CREDENTIAL')
  
        GIT_BRANCH = "ai-tests"
        REPO_URL = "https://saurabhstatusneo-crypto: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@github.com/saurabhstatusneo-crypto/jagah.git"
        HUSKY_SKIP_INSTALL = '0'
        GIT_COMMAND_PATH = "C:\\Users\\SaurabhSharma\\AppData\\Local\\Programs\\Git\\cmd" // NEW: Your confirmed Git path
       JAVA_HOME  = "C:\\Program Files\\Java\\jdk-17"
        MAVEN_HOME  = "C:\\opt\\tools\\maven"
       
             PATH = "${env.GIT_COMMAND_PATH};${env.MAVEN_HOME}\\bin;${env.JAVA_HOME};${env.PATH}"
    }

    stages {

        stage('Checkout SCM') {
            steps {
                powershell """
                    if (!(Test-Path '.git')) {
                        git clone '${env.REPO_URL}' .
                    } else {
                        git fetch origin
                    }

                    git rev-parse --verify ${env.GIT_BRANCH} > \$null 2>&1
                    if (\$LASTEXITCODE -eq 0) {
                        Write-Host "Switching to existing local branch: ${env.GIT_BRANCH}"
                        git checkout ${env.GIT_BRANCH} > \$null 2>&1

                        git ls-remote --exit-code origin ${env.GIT_BRANCH} > \$null 2>&1
                        if (\$LASTEXITCODE -eq 0) {
                            try { git pull origin ${env.GIT_BRANCH} } catch {}
                        } else {
                            Write-Host " No remote branch to pull from, continuing..."
                        }
                    } else {
                        git ls-remote --exit-code origin ${env.GIT_BRANCH} > \$null 2>&1
                        if (\$LASTEXITCODE -eq 0) {
                            Write-Host " Branch exists on remote. Checking out tracking branch..."
                            try { git checkout -b ${env.GIT_BRANCH} origin/${env.GIT_BRANCH} } catch { git checkout -b ${env.GIT_BRANCH} }
                        } else {
                            Write-Host "Branch does not exist locally or remotely. Creating new branch: ${env.GIT_BRANCH}"
                            git checkout -b ${env.GIT_BRANCH}
                        }
                    }

                    \$LASTEXITCODE = 0
                    exit \$LASTEXITCODE
                """
            }
        }

stage('Install Node.js Dependencies') {
    steps {
        powershell '''
            Write-Host "Installing Node.js dependencies..."

            # 1. Set environment variable using PowerShell syntax
            $env:HUSKY_SKIP_INSTALL = '0' 
            
            # 2. Run npm ci
            npm ci
            if ($LASTEXITCODE -ne 0) {
                Write-Host "npm ci failed, continuing..."
            }

            # 3. Run npx husky install
            npx husky install
            if ($LASTEXITCODE -ne 0) {
                Write-Host "husky install failed, continuing..."
            }
        '''
    }
}

        stage('Install Java Dependencies') {
            when { expression { fileExists('pom.xml') } }
            steps {
                powershell '''
                    echo " Installing Java/Maven dependencies..."
                       try {
                        mvn clean install -DskipTests
                    } catch {
                        Write-Host "Maven install failed, continuing..."
                    }
                    
                '''
            }
        }

        stage('Generate AI Tests (Node.js)') {
            when { expression { fileExists('package.json') && fileExists('scripts/generate-tests.js') } }
            steps {
                powershell '''
                    echo "Generating AI-based Node.js tests..."
                    try {
                        node scripts/generate-tests.js
                    } catch {
                        Write-Host " Node.js script failed, continuing..."
                    }
                '''
            }
        }

        stage('Generate AI Tests (Java/Spring Boot)') {
            when { expression { fileExists('scripts/generate-java-tests-new.js') } }
            steps {
                powershell '''
                    echo " Generating AI-based Java/Spring Boot tests..."

                    node -v
                    if ($LASTEXITCODE -ne 0) {
                        Write-Host " Node.js not installed on this Jenkins agent."
                        exit 1
                    }

                    if (-not (Test-Path "node_modules/groq-sdk")) {
                        Write-Host "Installing groq-sdk..."
                        npm install groq-sdk
                        if ($LASTEXITCODE -ne 0) {
                            Write-Host "Failed to install groq-sdk"
                            exit 1
                        }
                    }

                    try {
                        node scripts/generate-java-tests-new.js
                    } catch {
                        Write-Host " Java test generation failed, continuing..."
                    }
                '''
            }
        }

        stage('Commit and Push Before PR') {
    steps {
        powershell '''
            Write-Host " Checking for Git changes..."
            git status

            git add .
            try {
                git commit -m "AI Generated Tests"
            } catch {
                Write-Host " Nothing to commit"
            }

            Write-Host " Forcing GitHub token in remote URL..."
            git remote set-url origin  "${env.REPO_URL}"

            Write-Host " FORCE PUSHING branch..."
            git push origin ai-tests --force
        '''
    }
}
        stage('Run Tests') {
            steps {
                script {
                    if (fileExists('pom.xml')) {
                        powershell '''
                            try { mvn test } catch { Write-Host " Java tests failed, continuing..." }
                        '''
                    }
                }
            }
        }
    }

    post {
        always { echo "Pipeline finished" }
        success { echo " Pipeline succeeded!" }
        failure { echo " Pipeline failed â€” check logs." }
    }
}
